variant: fcos
version: 1.4.0
passwd:
    users:
        - name: core
          ssh_authorized_keys:
              - ssh-rsa AAAAB3NzaC1yc2EAAAADAQABAAABAQDxNpFK/kKbp53DJarquYTeNZXLnYNbSjQiEti24vRqHIRmD3wvLpX1NiiIY7xnP3rwEY8s1NjHarKXLYmCBrOZKkBxu5U6ROyLMCCfhCXBcJXUVJng1PmoJ4+hlIPWq3I136Y4ZP1xiKWKVuMa6vC06wqA5m6bh5TEqDNOP+cW6dn3qX7sy0qNtiZU8VmJ5fM9kHA02bZf3YYlK4780ESVY8RU3zOTZDvnOZUuIRLpMgsDH3eqyu2AKvnMNPrNxSYGffd6PXeng2rIEaV49/LnO1Cw61vDWYUL8jULzZ+SqE5ydnOUGfqguOTEYbtaXhBrYECgDCDGvRXF0VAaj3D7 jerred@jerred-macbook.local
          groups:
              - docker
storage:
    directories:
      - path: /var/docker-compose
    files:
        - path: /etc/hostname
          mode: 0644
          contents:
              inline: public.zeus.home.shepherdjerred.com
        - path: /etc/docker/daemon.json
          mode: 0600
          contents:
            inline: |
              {
                "data-root": "/var/storage/docker"
              }
    links:
        - path: /etc/localtime
          target: ../usr/share/zoneinfo/America/Los_Angeles
systemd:
    units:
        - name: custom-bootupd-auto.service
          enabled: false
          contents: |
            [Unit]
            Description=Bootupd automatic update

            [Service]
            ExecStart=/usr/bin/bootupctl update
            RemainAfterExit=yes

            [Install]
            WantedBy=multi-user.target
        - name: rpm-ostree-install-docker-compose.service
          enabled: true
          contents: |
            [Unit]
            Description=Layer docker-compose with rpm-ostree
            Wants=network-online.target
            After=network-online.target
            # We run before `zincati.service` to avoid conflicting rpm-ostree
            # transactions.
            Before=zincati.service
            ConditionPathExists=!/var/lib/%N.stamp

            [Service]
            Type=oneshot
            RemainAfterExit=yes
            ExecStart=/usr/bin/rpm-ostree install --apply-live docker-compose
            ExecStart=/bin/touch /var/lib/%N.stamp

            [Install]
            WantedBy=multi-user.target
        - name: var-storage.mount
          enabled: false
          contents: |
            [Unit]
            Before=local-fs.target,docker.service
            ConditionPathExists=/dev/md127

            [Mount]
            What=/dev/md127
            Where=/var/storage
            Type=ext4

            [Install]
            WantedBy=multi-user.target
        - name: clone-servers-git-repo.service
          enabled: true
          contents: |
            [Unit]
            Wants=network-online.target
            After=network-online.target
            Description=Clone shepherdjerred/servers git repo

            [Service]
            Type=oneshot
            RemainAfterExit=yes
            WorkingDirectory=/var/docker-compose
            ExecStart=/usr/bin/git clone https://github.com/shepherdjerred/servers/

            [Install]
            WantedBy=multi-user.target
        - name: docker-compose-reload.service
          enabled: false
          contents: |
            [Unit]
            Description=Refresh images and update containers

            [Service]
            Type=oneshot

            ExecStart=/bin/systemctl reload-or-restart docker-compose.service
        - name: docker-compose-reload.timer
          enabled: false
          contents: |
            [Unit]
            Description=Refresh images and update containers
            Requires=docker-compose.service
            After=docker-compose.service

            [Timer]
            OnCalendar=weekly
            Persistent=true

            [Install]
            WantedBy=timers.target
        - name: docker-compose.service
          enabled: false
          contents: |
            [Unit]
            Description=Docker Compose container starter
            After=docker.service network-online.target var-storage.mount rpm-ostree-install-docker-compose.service
            Requires=docker.service network-online.target

            [Service]
            WorkingDirectory=/var/docker-compose/servers/zeus
            Type=oneshot
            RemainAfterExit=yes

            ExecStartPre=/usr/bin/git reset --hard origin/main
            ExecStartPre=/usr/bin/git pull
            ExecStartPre=-/usr/bin/docker-compose pull
            ExecStart=/usr/bin/docker-compose up -d

            ExecStop=/usr/bin/docker-compose down

            ExecReload=/usr/bin/docker-compose pull
            ExecReload=/usr/bin/docker-compose up -d

            [Install]
            WantedBy=multi-user.target
