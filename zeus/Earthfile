VERSION 0.6
FROM alpine
WORKDIR /workspace

out:
  FROM +render
  SAVE ARTIFACT * AS LOCAL ./out/

render:
  COPY config ./config/
  COPY static ./static/
  COPY ../common+caddy/ ./config/caddy
  COPY ../common+config.vars/ .
  COPY ../common+config.blackbox/ ./config
  COPY ../common+config.loki/ ./config
  COPY ../common+config.promtail/ ./config/promtail
  COPY +render.varken/ ./config/
  COPY +render.docker-compose/ ./
  SAVE ARTIFACT *

lint:
  FROM ../common+lint.docker-compose
  COPY docker-compose.yml .
  RUN ./lint.py

gomplate:
  FROM golang:alpine
  WORKDIR /workspace
  RUN go install github.com/hairyhenderson/gomplate/v3/cmd/gomplate@latest

render.docker-compose:
  FROM +gomplate
  COPY docker-compose.yml .
  RUN --secret=DATADOG_API_KEY=+secrets/sj/datadog_api_key --secret=AWS_ACCESS_KEY_ID=+secrets/sj/aws_access_key_id --secret=AWS_SECRET_ACCESS_KEY=+secrets/sj/aws_secret_access_key gomplate -f docker-compose.yml -o docker-compose.yml
  SAVE ARTIFACT docker-compose.yml

render.varken:
  FROM +gomplate
  COPY config/varken.ini .
  RUN --secret=MAXMIND_LICENSE_KEY=+secrets/sj/zeus/maxmind_license_key --secret=INFLUXDB_PASSWORD=+secrets/sj/zeus/influxdb_password --secret=TAUTULLI_API_KEY=+secrets/sj/zeus/tautulli_api_key --secret=SONARR_API_KEY=+secrets/sj/zeus/sonarr_api_key --secret=RADARR_API_KEY=+secrets/sj/zeus/radarr_api_key gomplate -f varken.ini -o varken.ini
  SAVE ARTIFACT varken.ini
